{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-cog"></i> Bot Settings</h2>
    
    <form method="POST">
        <!-- Deriv API Section -->
        <div class="form-group">
            <label class="form-label">üîê Deriv API Token</label>
            <input type="password" name="deriv_token" 
                   value="{{ deriv_token }}"
                   class="form-control" 
                   placeholder="Enter your Deriv API token"
                   required>
            <small class="text-muted">Get your API token from Deriv.com ‚Üí Settings ‚Üí API</small>
        </div>
        
        <hr>
        
        <!-- Trading Settings -->
        <h3 class="mt-3">üéØ Trading Settings</h3>
        
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Min Confidence (%)</label>
                    <input type="number" name="min_confidence" 
                           value="{{ settings.min_confidence }}"
                           class="form-control" min="0" max="100" step="1" required>
                    <small class="text-muted">55-65 recommended</small>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Trade Amount ($)</label>
                    <input type="number" name="trade_amount" 
                           value="{{ settings.trade_amount }}"
                           class="form-control" min="0.35" max="100" step="0.01" required>
                    <small class="text-muted">Amount per trade</small>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Max Daily Trades</label>
                    <input type="number" name="max_daily_trades" 
                           value="{{ settings.max_daily_trades }}"
                           class="form-control" min="1" max="500" required>
                    <small class="text-muted">Stop after X trades</small>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Max Concurrent Trades</label>
                    <input type="number" name="max_concurrent" 
                           value="{{ settings.max_concurrent }}"
                           class="form-control" min="1" max="10" required>
                    <small class="text-muted">Trades at same time</small>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Scan Interval (seconds)</label>
                    <input type="number" name="scan_interval" 
                           value="{{ settings.scan_interval }}"
                           class="form-control" min="1" max="60" required>
                    <small class="text-muted">How often to scan</small>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group">
                    <label class="form-label">Risk Level</label>
                    <select name="risk_level" class="form-control">
                        <option value="0.5" {% if settings.risk_level == 0.5 %}selected{% endif %}>Low (0.5x)</option>
                        <option value="1.0" {% if settings.risk_level == 1.0 %}selected{% endif %}>Normal (1x)</option>
                        <option value="1.5" {% if settings.risk_level == 1.5 %}selected{% endif %}>High (1.5x)</option>
                        <option value="2.0" {% if settings.risk_level == 2.0 %}selected{% endif %}>Aggressive (2x)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <hr>
        
        <!-- Market Selection -->
        <h3 class="mt-3">üìà Select Markets</h3>
        
        <div class="form-group">
            <div class="row">
                {% for symbol, info in markets.items() %}
                <div class="col-6">
                    <div class="checkbox-group">
                        <input type="checkbox" 
                               name="markets" 
                               value="{{ symbol }}"
                               id="market_{{ symbol }}"
                               {% if symbol in settings.markets %}checked{% endif %}>
                        <label for="market_{{ symbol }}" class="checkbox-label">
                            <strong>{{ symbol }}</strong><br>
                            <small class="text-muted">{{ info.name }}</small>
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <hr>
        
        <!-- Dry Run Mode -->
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" 
                       name="dry_run" 
                       id="dry_run"
                       {% if settings.dry_run %}checked{% endif %}>
                <label for="dry_run" class="checkbox-label">
                    <strong>Enable Dry Run Mode</strong><br>
                    <small class="text-muted">Test without real money</small>
                </label>
            </div>
        </div>
        
        <!-- Save Button -->
        <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-save"></i> Save Settings
        </button>
    </form>
</div>

<!-- Test Connection -->
<div class="card mt-3">
    <h3><i class="fas fa-wifi"></i> Test Connection</h3>
    <button onclick="testDerivConnection()" class="btn btn-outline btn-block">
        Test Deriv Connection
    </button>
    <div id="testResult" class="mt-2"></div>
</div>

<script>
    async function testDerivConnection() {
        const token = document.querySelector('input[name="deriv_token"]').value;
        if (!token) {
            alert('Please enter your Deriv API token first');
            return;
        }
        
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = '<div class="loading"></div> Testing...';
        
        try {
            // Simple test by trying to connect
            const response = await fetch('https://api.deriv.com/api/v1/ping', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Connection successful!</div>';
            } else {
                resultDiv.innerHTML = '<div class="alert alert-error"><i class="fas fa-times-circle"></i> Connection failed. Check your API token.</div>';
            }
        } catch (error) {
            resultDiv.innerHTML = '<div class="alert alert-error"><i class="fas fa-times-circle"></i> Connection error: ' + error.message + '</div>';
        }
    }
</script>
{% endblock %}
